<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Global Notices | Principal Portal</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="../assets/css/styles.css">
</head>

<body>
    <header class="glass"
        style="position: sticky; top: 20px; z-index: 1000; display: flex; justify-content: space-between; align-items: center; margin: 0 auto; width: 95%; max-width: 1400px; border-radius: 16px;">
        <a href="index.html" class="logo" style="text-decoration: none; display: flex; align-items: center; gap: 10px;">
            <i class="fa-solid fa-building-columns"></i> CampusCare <span
                style="font-size:0.8rem; background:#7c3aed; color:white; padding:2px 8px; border-radius:10px;">PRINCIPAL</span>
        </a>
        <div><a href="index.html" style="text-decoration:none; color:#2d3748; font-weight:600;">Dashboard</a></div>
    </header>
    <!-- Dashboard Button -->
    <div class="dashboard-nav-bar" style="max-width: 1400px; width: 95%; margin: 30px auto 0px; display: flex; justify-content: flex-end;">
        <a href="index.html" class="dashboard-floating-btn">Dashboard</a>
    </div>
    <main class="main-container">
        <section class="hero teacher-hero" style="background: transparent;">
            <div class="hero-left">
                <h1 class="hero-title" style="color:#2d3748;">Global Notices</h1>
                <p class="hero-sub" style="color:#4a5568;">Institute-wide Announcements</p>
            </div>
        </section>

        <section class="standard-container">
            <div
                style="margin-bottom:2rem; background:white; padding:1.5rem; border-radius:15px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);">
                <h3 style="margin-bottom:1rem; color:#2d3748; border-bottom: 2px solid #f0f0f0; padding-bottom: 10px;">
                    Create Global Notice</h3>

                <div style="margin-bottom: 1rem;">
                    <label style="display:block; margin-bottom:0.5rem; color:#4a5568; font-weight:500;">Notice
                        Title</label>
                    <input type="text" id="noticeTitle" placeholder="Enter notice title"
                        style="width:100%; border:1px solid #cbd5e1; padding:0.8rem; border-radius:8px;">
                </div>

                <div style="margin-bottom: 1rem;">
                    <label style="display:block; margin-bottom:0.5rem; color:#4a5568; font-weight:500;">Target
                        Audience</label>
                    <select id="noticeAudience"
                        style="width:100%; border:1px solid #cbd5e1; padding:0.8rem; border-radius:8px; background:white;">
                        <option value="general">General (Everyone)</option>
                        <option value="student">All Students Only</option>
                        <option value="teacher">All Faculty Members Only</option>
                        <option value="hod">All HODs Only</option>
                        <option value="warden">All Wardens Only</option>
                    </select>
                </div>

                <div style="margin-bottom: 1rem;">
                    <label style="display:block; margin-bottom:0.5rem; color:#4a5568; font-weight:500;">Message
                        Content</label>
                    <textarea id="noticeContent" placeholder="Write your announcement here..."
                        style="width:100%; border:1px solid #cbd5e1; padding:1rem; border-radius:10px;"
                        rows="5"></textarea>
                </div>

                <button onclick="postNotice()"
                    style="background:#7c3aed; color:white; padding:0.8rem 1.5rem; border:none; border-radius:8px; cursor:pointer; font-weight:600; transition: all 0.2s;">
                    <i class="fa-solid fa-paper-plane"></i> Broadcast Notice
                </button>
            </div>

            <!-- Recent Notices List -->
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem;">
                <h3 style="color:#2d3748; margin:0;">Recent Broadcasts</h3>
                <select id="filterAudience" onchange="filterNotices()"
                    style="border:1px solid #cbd5e1; padding:0.5rem; border-radius:8px; background:white; color:#4a5568;">
                    <option value="all">Show All</option>
                    <option value="general">General</option>
                    <option value="student">Students</option>
                    <option value="teacher">Faculty</option>
                    <option value="hod">HODs</option>
                    <option value="warden">Wardens</option>
                </select>
            </div>
            <div id="noticesList" style="display:flex; flex-direction:column; gap:1rem;">
                <!-- Notices will be loaded here -->
            </div>
        </section>
    </main>

    <script>
        const API_URL = 'http://localhost:5000/api';

        document.addEventListener('DOMContentLoaded', () => {
            const userStr = localStorage.getItem('user');
            if (!userStr) {
                window.location.href = '../login.html';
                return;
            }
            loadNotices();
        });

        async function postNotice() {
            const userStr = localStorage.getItem('user');
            if (!userStr) return;
            const user = JSON.parse(userStr);

            const title = document.getElementById('noticeTitle').value;
            const content = document.getElementById('noticeContent').value;
            const audience = document.getElementById('noticeAudience').value;

            if (!title || !content) {
                alert('Please fill in all fields');
                return;
            }

            try {
                const response = await fetch(`${API_URL}/notices`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${user.token}`
                    },
                    body: JSON.stringify({
                        title,
                        content,
                        audience,
                        userId: user._id
                        // targetDept is undefined so it applies generally based on audience
                    })
                });

                if (response.ok) {
                    alert('Notice Posted Successfully!');
                    document.getElementById('noticeTitle').value = '';
                    document.getElementById('noticeContent').value = '';
                    loadNotices(); // Reload list
                } else {
                    alert('Failed to post notice');
                }
            } catch (error) {
                console.error(error);
                alert('Error posting notice');
            }
        }

        let globalNotices = []; // Store fetched notices globally for filtering

        async function loadNotices() {
            const userStr = localStorage.getItem('user');
            if (!userStr) return;
            const user = JSON.parse(userStr);

            try {
                const response = await fetch(`${API_URL}/notices?role=${user.role}&userId=${user._id}`, {
                    headers: { 'Authorization': `Bearer ${user.token}` }
                });

                if (!response.ok) throw new Error('Failed to load');
                globalNotices = await response.json();
                renderNotices(globalNotices);

            } catch (error) {
                console.error(error);
            }
        }

        function filterNotices() {
            const filterValue = document.getElementById('filterAudience').value;
            if (filterValue === 'all') {
                renderNotices(globalNotices);
            } else {
                const filtered = globalNotices.filter(notice => notice.audience === filterValue);
                renderNotices(filtered);
            }
        }

        function renderNotices(notices) {
            const list = document.getElementById('noticesList');
            list.innerHTML = '';

            if (notices.length === 0) {
                list.innerHTML = '<p style="color:#666;">No notices found.</p>';
                return;
            }

            notices.forEach(notice => {
                const date = new Date(notice.date).toLocaleDateString();
                const audienceLabel = notice.audience.toUpperCase();

                let audColor = '#3b82f6'; // Blue
                if (notice.audience === 'general') audColor = '#10b981'; // Green
                if (notice.audience === 'student') audColor = '#f59e0b'; // Orange
                if (notice.audience === 'teacher') audColor = '#8b5cf6'; // Purple
                if (notice.audience === 'hod') audColor = '#ec4899'; // Pink
                if (notice.audience === 'warden') audColor = '#6366f1'; // Indigo

                const item = document.createElement('div');
                item.className = 'standard-card';
                item.style.padding = '1.5rem';
                item.innerHTML = `
                    <div style="display:flex; justify-content:space-between; align-items:start; margin-bottom:0.5rem;">
                        <h4 style="margin:0; color:#2d3748;">${notice.title}</h4>
                        <span style="font-size:0.8rem; background:${audColor}; color:white; padding:2px 8px; border-radius:12px;">${audienceLabel}</span>
                    </div>
                    <p style="color:#4a5568; margin-bottom:0.5rem; line-height:1.5;">${notice.content}</p>
                    <div style="font-size:0.85rem; color:#94a3b8;">Posted on: ${date}</div>
                `;
                list.appendChild(item);
            });
        }
    </script>
    </main>
</body>

</html>